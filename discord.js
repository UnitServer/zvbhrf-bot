const e = require("express");

function updateActivity() {
    var total = 0

    client.guilds.cache.forEach( function( guild ) {
        total = total + guild.memberCount
    } );

    client.user.setActivity( String( total ) + " members", { 
        type: "LISTENING",
    } );
}

/////

function sendSuccess( desc, message ) {
    var emb = new discord.MessageEmbed()
        .setColor( "#32a852" )
        .setTitle( "–£—Å–ø–µ—à–Ω–æ" )
        .setDescription( desc );

    message.channel.send( emb );
};

function sendError( desc, message ) {
    var emb = new discord.MessageEmbed()
        .setColor( "#eb4037" )
        .setTitle( "–û—à–∏–±–∫–∞" )
        .setDescription( desc );

    message.channel.send( emb );
};

/////

function userHasRole( message, author, role ) {
    let grole = message.guild.roles.cache.find( r => r.name === role );

    if ( grole ) {
        var dat = author.roles.cache.find( r => r.name === role );

        if ( dat ) {
            return dat
        };
    } else {
        sendError( `–ü–æ—Ö–æ–∂–µ, —á—Ç–æ —É –≤–∞—Å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ä–æ–ª—å \`${ role }\`!`, message )
    };
};

//

const cooldowns = new Set();
var cooldown_time = 4

//

var bot_info = {
    author: "Zvbhrf#7309",
    version: "1.0.2",
    description: "–§–∞–Ω-–±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –ø–æ –ø—Ä–∏–∫–æ–ª—É ;)",
}

var prefix = "#"
var cmds = {
    "help": {
        args: "",
        desc: "–í—ã–≤–µ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ `uTool`",
        func: function( message, args, cmd ) {
            var txt = ""

            for( let key of Object.keys( cmds ) ) {
                var dat = cmds[ key ];

                txt += `\`${ prefix }${ key }${ dat.args != "" ? " " + dat.args : "" }\` - ${ dat.desc }\n`
            };
            
            var msg = new discord.MessageEmbed()
                .setColor( "#32a852" )
                .setTitle( "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã" )
                .setDescription( txt )

            message.reply( msg );
        }
    },

    "info": {
        args: "",
        desc: "–í—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ",
        func: function( message, args, cmd ) {
            message.channel.send( `–ë–æ—Ç —Å–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: \`${ bot_info.author }\`\n–í–µ—Ä—Å–∏—è: \`${ bot_info.version }\`\n–ü–æ–¥—Ä–æ–±–Ω–µ–µ: \`${ bot_info.description }\`` );
        }
    },

    "invite": {
        args: "",
        desc: "–í—ã–≤–µ—Å—Ç–∏ —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –±–æ—Ç–∞ –≤ –≤–∞—à Discord —Å–µ—Ä–≤–µ—Ä",
        func: function( message, args, cmd ) {
            message.reply( "–¥–µ—Ä–∂–∏: https://discord.com/api/oauth2/authorize?client_id=898865198918676510&permissions=8&scope=bot\n–°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Ö–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å –º–µ–Ω—è üòç" )
        }
    },

    "random": {
        args: "N:N",
        desc: "–í—ã–≤–æ–¥–∏—Ç —Ä–∞–Ω–¥–æ–º–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç –∏ –¥–æ",
        func: function( message, args, cmd ) {
            var nums = args[1].split( ":" );
            var max = 9999999

            if ( !Number( nums[ 0 ] ) || !Number( nums[ 1 ] ) ) { 
                message.channel.send( "–ù–µ–≤–µ—Ä–Ω–Ω–æ –≤–≤–µ–¥–µ–Ω—ã –∞—Ä–≥—É–º–µ–Ω—Ç—ã" );

                return 
            };

            nums[ 0 ] = clamp( nums[ 0 ], -max, max )
            nums[ 1 ] = clamp( nums[ 1 ], -max, max )

            message.channel.send( `–í—ã–ø–∞–ª–æ —á–∏—Å–ª–æ: \`${ Math.floor( randomFromTo( nums[0], nums[1] ) ) }\`` );
        }
    },

    "db": {
        args: "STEAMID/STEAMID64/PROFILE-URL",
        desc: "–£–∑–Ω–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ, –∫–æ—Ç–æ—Ä—ã–π –∏–≥—Ä–∞–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ",
        func: function( message, args, cmd ) {
            if ( !args[1] ) {
                var dat = cmds[ cmd ];

                message.reply( `\`${ prefix }${ cmd }${ dat.args != "" ? " " + dat.args : "" }\` - ${ dat.desc }` );
                
                return
            };

            var options = {
                host: "gmodugolochek.ru",
                path: "/api/player?s=" + args[1],

                method: "GET"
            };

            http.request( options, function( res ) {
                var str = ""

                res.on( "data", function( chunk ) {
                    if ( message ) {
                        str += chunk
                        
                        var msg

                        //

                        switch( str ) {
                            case "error":
                                msg = "–û—à–∏–±–∫–∞: `–ù–µ–≤–µ—Ä–Ω–æ –≤–≤–µ–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ`"
                            break

                            case "nil":
                                msg = "–û—à–∏–±–∫–∞: `–ò–≥—Ä–æ–∫–∞ –Ω–µ—Ç—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö`"
                            break

                            default:
                                var dat = JSON.parse( str );
                                var time = new Date( Number( dat.lastvisit ) * 1000 )
                                var col = dat.color.split( "," );
                                
                                msg = new discord.MessageEmbed()
                                    .setColor( rgbToHex( col[0], col[1], col[2] ) )
                                    .setAuthor( dat.name, dat.avatar, "https://gmodugolochek.ru/?steamid=" + dat.steamid )
                                    .setDescription( `–ù–∏–∫: \`${ dat.name }\`\n–ì—Ä—É–ø–ø–∞: \`${ dat.team }\`\n
                                        –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: \`${ time.getHours() }:${ time.getMinutes() }:${ time.getSeconds() } ${ time.getDay() }/${ time.getMonth() + 1 }/${ time.getFullYear() } –ú–°–ö\`` )

                                if ( dat.ban ) {
                                    var time_banned = new Date( Number( dat.ban.time ) * 1000 )
                                    var time_unban = new Date( Number( dat.ban.unban ) * 1000 )

                                    var banned = `–û—á–µ–Ω—å –¥–∞–≤–Ω–æ`
                                    var unban = `–ù–∏–∫–æ–≥–¥–∞`

                                    if ( dat.ban.unban != "0" ) {
                                        unban = `${ time_unban.getHours() }:${ time_unban.getMinutes() }:${ time_unban.getSeconds() } ${ time_unban.getDay() }/${ time_unban.getMonth() + 1 }/${ time_unban.getFullYear() } –ú–°–ö`
                                    }

                                    if ( time_banned != 0 ) {
                                        banned = `${ time_banned.getHours() }:${ time_banned.getMinutes() }:${ time_banned.getSeconds() } ${ time_banned.getDay() }/${ time_banned.getMonth() + 1 }/${ time_banned.getFullYear() } –ú–°–ö`
                                    }

                                    var ban = new discord.MessageEmbed()
                                        .setColor( "#eb4037" )
                                        .setTitle( `${ dat.name } - –ò–≥—Ä–æ–∫ –≤ –±–∞–Ω–µ` )
                                        .setDescription( `–ü—Ä–∏—á–∏–Ω–∞: \`${ dat.ban.reason }\`\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: \`${ dat.ban.admin }\`\n
                                            –†–∞–∑–±–∞–Ω: \`${ unban }\`\n–î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–Ω–∞: \`${ banned }\`` )


                                    setTimeout( function() { 
                                        message.reply( ban );
                                    }, 50 )
                                };
                            break
                        }

                        //
                
                        message.reply( msg ); // TODO: –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ message.channel.send, —Å–µ–π—á–∞—Å –æ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç???
                    };
                });
            } ).end();
        },
    },

    ///// ADMINISTRARION /////

    "kick": {
        args: "Mention",
        desc: "–ö–∏–∫–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
        func: function( message, args, cmd ) {
            if ( args[1] ) {
                if ( userHasRole( message, message.member, "uTool-Admin" ) ) {
                    var user = message.mentions.members.first();
                    var p = userHasRole( message, user, "uTool-Admin" );

                    if ( p ) {
                        sendError( `–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∫–∏–∫–Ω—É—Ç—å –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (\`${ user.user.username }\`), —Ç–∞–∫-–∫–∞–∫ —É –Ω–µ–≥–æ –µ—Å—Ç—å —Ä–æ–ª—å \`uTool-Admin\``, message );
                    } else {
                        user.kick().then( ( member ) => {
                            sendSuccess( member.displayName + " –±—ã–ª –∫–∏–∫–Ω—É—Ç :wave:", message );
                        } ).catch( () => {
                            sendError( `–ü–æ—Ö–æ–∂–µ, —á—Ç–æ —É –º–µ–Ω—è –Ω–µ—Ç—É —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∫–∏–∫ \`${ user.user.username }\`. –ú–Ω–µ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã—à–µ —á–µ–º –º–æ—è`, message );
                        } );
                    };
                } else {
                    sendError( `–£ –≤–∞—Å –Ω–µ—Ç—É —Ä–æ–ª–∏ \`uTool-Admin\``, message )
                };
            } else {
                sendError( `–ù–µ —É–∫–∞–∑–∞–Ω –∞—Ä–≥—É–º–µ–Ω—Ç \`Mention\``, message )
            };
        }
    },

    "ban": {
        args: "Mention",
        desc: "–ë–∞–Ω–∏—Ç —é–∑–µ—Ä–∞",
        func: function( message, args, cmd ) {
            if ( args[1] ) {
                if ( userHasRole( message, message.member, "uTool-Admin" ) ) {
                    var user = message.mentions.members.first();
                    var p = userHasRole( message, user, "uTool-Admin" );

                    if ( p ) {
                        sendError( `–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (\`${ user.user.username }\`), —Ç–∞–∫-–∫–∞–∫ —É –Ω–µ–≥–æ –µ—Å—Ç—å —Ä–æ–ª—å \`uTool-Admin\``, message );
                    } else {
                        user.ban().then( ( member ) => {
                            sendSuccess( member.displayName + " –±—ã–ª –∑–∞–±–∞–Ω–µ–Ω :wave:", message );
                        } ).catch( () => {
                            sendError( `–ü–æ—Ö–æ–∂–µ, —á—Ç–æ —É –º–µ–Ω—è –Ω–µ—Ç—É —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –±–∞–Ω \`${ user.user.username }\`. –ú–Ω–µ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã—à–µ —á–µ–º –º–æ—è`, message );
                        } );
                    };
                } else {
                    sendError( `–£ –≤–∞—Å –Ω–µ—Ç—É —Ä–æ–ª–∏ \`uTool-Admin\``, message )
                };
            } else {
                sendError( `–ù–µ —É–∫–∞–∑–∞–Ω –∞—Ä–≥—É–º–µ–Ω—Ç \`Mention\``, message )
            };
        }
    },
};

//

let client = new discord.Client( { 
    restTimeOffset: 150,
    messageCacheMaxSize: 100,
} )

client.on( "message", message => {
    if ( message.author.bot ) { return };

    var args = message.content.split( " " );
    var cmd = args[0].split( prefix )[1];
    
    //if ( args[ 0 ].split( "" ) != prefix ) { return };
    if ( !cmds[ cmd ] ) { return };

    //

    if ( cooldowns.has( message.author.id ) ) {
        return
    } else {
        cooldowns.add( message.author.id );

        setTimeout( function() {
            cooldowns.delete( message.author.id );

        }, cooldown_time * 1000 );
    };

    //

    cmds[ cmd ].func( message, args, cmd );
});

client.on( "ready", () => {
    console.log( `Logged in as ${ client.user.tag }` );

    setInterval( function() {
        updateActivity();
    }, 600 * 1000 );

    updateActivity();
} );

client.login( "TOKEN-HERE" );
